{% extends 'dashboard/layout.html' %}
{% load eztables %}

{% block extracss %}
    {% datatables_bootstrap_css %}
{% endblock %}

{% block content %}
    <div class="table-responsive">
        <table id="my-table">
            <thead>
                {% for table_title in titles %}
                    {% if  table_title == "checkbox" %}
                        
                    <th><input type="checkbox" name="select_all" value="1" id="example-select-all"></th>
                    {% else %}
                    <th> {{ table_title|title }} </th>
                    {% endif %}
                {% endfor %}
            </thead>
        </table>
    </div>

    <div class="modal fade" id="test_key-modal" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Test Keys</h4>
        </div>
        <div class="modal-body">
            <div class="col-md-12 form-group">
                
                    <textarea id="modal-textarea" class="col-md-12 form-control" rows="10"></textarea>
            </div>
                
                
            
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}


{% block extrajs %}
{% datatables_js %}
{% datatables_bootstrap_js %}
<script>

    $(function () {
        
        var url_datatable = '{{url_ajax}}';

        var list = {{ aoColumns_json|safe }};

        var arrayLength = list.length;
        for (var i = 0; i < arrayLength; i++) {
            if (list[i]['mData'] == "checkbox"){
                list[i]['bSortable'] = false;
                list[i]['bSearchable'] = false;
                list[i]['mRender'] = function ( data ) {
                    return '<input type="checkbox" name="' + data + '" value="1">'
                    };

            };
            if (list[i]['mData'] == "report_id"){
                 list[i]['mRender'] = function ( data ) {
                        if (data != null){
                            var url_report = "{% url 'measurements:measurement_front:detail-report' 'data' %}".replace('data', data)
                            url_report = "<a href='" + url_report + "'>" + data + "</a>";
                            return url_report;
                        }else{
                            return '';
                        }
                   };
            };
            if (list[i]['mData'] == "flag"){
                 list[i]['mRender'] = function ( data, type, full ) {

                        var flag_icon = "";
                        if(full.is_flag == true){

                            if (data == true){
                            flag_icon = 'Hard <i class="glyphicon glyphicon-flag" style="color: red;" aria-hidden="true"></i><span class="hide">hard</span>';
                            }
                            if (data == false){
                                flag_icon = 'Soft <i class="glyphicon glyphicon-flag" style="color: yellow;" aria-hidden="true"></i><span class="hide">soft</span>';
                            }
                            if (data == null){
                                flag_icon = 'Muted <i class="glyphicon glyphicon-flag" style="color: gray;" aria-hidden="true"></i><span class="hide">mute</span>';
                            }
                        }else{
                            flag_icon = "No Flag";
                        }


                        return flag_icon;
                    }
            };
            if (list[i]['mData'] == "test keys"){
                 list[i]['mRender'] = function ( data, type, full ) {

                        var test_key_content = JSON.stringify(data, null, 2);

                        return '<textarea rows="6" class="test-key-area" metric-id="'
                            +
                            full.checkbox
                            +
                            '">' + test_key_content + '</textarea> <button type="button" class="btn btn-info test_key-button" metric-id="'
                            +
                            full.checkbox
                            +
                            '"> Open </button>';
                    }
            };
            if (list[i]['mData'] == "manual flag"){
                 list[i]['mRender'] = function ( data, type, full ) {

                        var flag_icon = "";
                        if(full.is_flag != null){

                            if (data == true){
                                flag_icon = '<i class="glyphicon glyphicon-flag" style="color: black;" aria-hidden="true"></i><span class="hide">manual</span>';
                            }
                            if (data == false){
                                flag_icon = 'Automatic';
                            }
                            if (data == null){
                                flag_icon = '';
                            }
                        }else{
                            flag_icon = "";
                        }


                        return flag_icon;
                    }
            };
            if (list[i]['mData'] == "measurement"){
                 list[i]['mRender'] = function ( data, type, full ) {
                        if (data != null){
                            var url_measurement = "{% url 'measurements:measurement_front:detail-measurement' 'data' %}".replace('data', full.checkbox)
                            url_measurement = "<a href='" + url_measurement + "'>" + data + "</a>";
                            return url_measurement
                        }else{
                            return '';
                        }
                   }
            };
            if (list[i]['mData'] == "control resolver answers"){
                 list[i]['mRender'] = function ( data, type, full ) {

                        var cr_answers_content = JSON.stringify(data, null, 2);

                        return '<textarea rows="6" class="cr-answers-area">' + cr_answers_content + '</textarea>';
                    }
            };
            if (list[i]['mData'] == "answers"){
                 list[i]['mRender'] = function ( data, type, full ) {

                        var answers_content = JSON.stringify(data, null, 2);

                        return '<textarea rows="6" class="answers-area">' + answers_content + '</textarea>';
                    }
            };

        };

        $('#my-table').dataTable({
            "bProcessing": true,
            "bServerSide": true,
            "sAjaxSource": url_datatable,
            "aoColumns": list,
        });

        $(document).on("click", ".test_key-button", function () {
             var metric_id = $(this).attr('metric-id');
             var test_keys = $('.test-key-area[metric-id="'+ metric_id +'"]').val();
             // var test_keys = 1;
             // alert(test_keys);
             $('#modal-textarea').val(test_keys);
             // alert($('#modal-textarea').val());
             $('#test_key-modal').modal('show');
             // alert('hola mundo');
        });

        // Handle click on a row of table
        $('#my-table tbody').on('click', 'tr', function () {

            $( this ).toggleClass('selected');
            if( $( this ).hasClass( 'selected' ) ){
                $(this).find(":checkbox").prop("checked", true);
            }else{
                $(this).find(":checkbox").prop("checked", false);
            }

        });

        // Handle click on "Select all" control
        $('#example-select-all').on('click', function(){
            // Get all rows with search applied
            var rows = $('#my-table').find('tbody').find('tr');
            // Check/uncheck checkboxes for all rows in the table
            $('input[type="checkbox"]', rows).prop('checked', this.checked);
            $(rows).each(function() {
               var checked = $('input[type="checkbox"]', rows).prop('checked');
                if(checked){
                    $(this).addClass('selected', checked);
                }else{
                    $(this).removeClass('selected');
                }

                if( $( this ).hasClass( 'selected' ) ){
                    $(this).find(":checkbox").prop("checked", true);
                }else{
                    $(this).find(":checkbox").prop("checked", false);

                }

            });



        });

    })

</script>
{% endblock %}